{% extends "base.html" %}
{% block title %}Facility Detail{% endblock %}
{% block content %}

<main class="container">
  <h1>Facility</h1>

  <section class="card">
    <h2 id="fac-name">Facility: …</h2>
    <p id="fac-loc">Location: …</p>
    <p id="fac-id">ID: …</p>
    <p id="fac-grid">Grid Region: …</p>
  </section>

  <section class="card">
    <h2>Quick Metrics (manual entry)</h2>
    <p>Enter activity values with units so they can be logged as Scope 1/2 activities later.</p>

    <form id="quick-metrics-form" class="grid-2">
      <label>
        Monthly Electricity (kWh)
        <input type="number" step="0.01" name="kwh" placeholder="kWh" />
      </label>
      <label>
        Natural Gas (therms)
        <input type="number" step="0.01" name="therms" placeholder="therms" />
      </label>
      <label>
        Diesel (gallons)
        <input type="number" step="0.01" name="diesel_gal" placeholder="gal" />
      </label>
      <label>
        Water (m³)
        <input type="number" step="0.01" name="water_m3" placeholder="m³" />
      </label>
      <div>
        <button type="submit">Save Metrics</button>
      </div>
    </form>

    <small>Units: electricity=kWh, gas=therms, diesel=gallons, water=cubic meters.</small>
    <p id="metrics-msg" style="margin-top:.5rem;"></p>
  </section>

  <section class="card">
    <h2>Recent Activity (placeholder)</h2>
    <div id="recent-activity">No entries yet.</div>
  </section>
</main>

<script>
(function () {
  const FACILITY_ID =
      (typeof window.FACILITY_ID !== "undefined" && window.FACILITY_ID) ||
      window.location.pathname.split("/").pop();

  const token = localStorage.getItem("token") || "";

  const nameEl = document.getElementById("fac-name");
  const locEl  = document.getElementById("fac-loc");
  const idEl   = document.getElementById("fac-id");
  const gridEl = document.getElementById("fac-grid");
  const metricsForm = document.getElementById("quick-metrics-form");
  const metricsMsg  = document.getElementById("metrics-msg");

  function setMetricsMsg(text, ok = true) {
    metricsMsg.textContent = text;
    metricsMsg.style.color = ok ? "lightgreen" : "crimson";
  }

  async function loadFacility() {
    try {
      const resp = await fetch(`/api/facilities/${FACILITY_ID}`, {
        credentials: "same-origin",
        headers: token ? { "Authorization": `Bearer ${token}` } : {}
      });
      if (!resp.ok) {
        console.error("Failed to load facility");
        return;
      }
      const data = await resp.json();

      nameEl.textContent = `Facility: ${data.name}`;
      locEl.textContent  = `Location: ${data.location ?? ""}`;
      idEl.textContent   = `ID: ${data.facility_id}`;
      gridEl.textContent = `Grid Region: ${data.grid_region_code ?? ""}`;

    } catch (err) {
      console.error(err);
    }
  }

  metricsForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(metricsForm);
    const payload = {
      kwh:       formData.get("kwh")       ? Number(formData.get("kwh"))       : null,
      therms:    formData.get("therms")    ? Number(formData.get("therms"))    : null,
      diesel_gal:formData.get("diesel_gal")? Number(formData.get("diesel_gal")): null,
      water_m3:  formData.get("water_m3")  ? Number(formData.get("water_m3"))  : null,
    };

    // if everything is empty, do nothing
    if (!payload.kwh && !payload.therms && !payload.diesel_gal && !payload.water_m3) {
      setMetricsMsg("No values entered.", false);
      return;
    }

    try {
      const resp = await fetch(`/api/activities/quick/${FACILITY_ID}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(token ? { "Authorization": `Bearer ${token}` } : {})
        },
        credentials: "same-origin",
        body: JSON.stringify(payload),
      });

      const text = await resp.text();

      if (!resp.ok) {
        setMetricsMsg(`Save failed: ${text}`, false);
        return;
      }

      setMetricsMsg("Metrics saved and logged as activities.", true);
    } catch (err) {
      console.error(err);
      setMetricsMsg("Error saving metrics.", false);
    }
  });

  loadFacility();
})();
</script>

{% endblock %}
