{% extends "base.html" %}
{% block title %}Facility Detail{% endblock %}
{% block content %}
<main class="container">
  <h1>Facility</h1>

  <!-- Facility Info -->
  <section class="card">
    <h2 id="fac-name">Facility: …</h2>
    <p id="fac-loc">Location: …</p>
    <p id="fac-id">ID: …</p>
    <p id="fac-grid">Grid Region: …</p>
  </section>

  <!-- Add Activity Button -->
  <section class="card">
    <a class="btn" href="/activities/new?facility_id={{ facility_id }}">
      Add Activity
    </a>
  </section>

  <!-- Recent Activity -->
  <section class="card">
    <h2>Recent Activity</h2>
    <div id="recent-activity">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="activities-tbody">
            <tr><td colspan="5">No entries yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
  (function () {
    const FACILITY_ID =
      (typeof window.FACILITY_ID !== "undefined" && window.FACILITY_ID) ||
      window.location.pathname.split("/").pop();

    const token = localStorage.getItem("token") || "";

    const nameEl      = document.getElementById("name");
    const locationEl  = document.getElementById("location");
    const gridEl      = document.getElementById("grid_region_code");
    const msgEl       = document.getElementById("message");
    const recentBox   = document.getElementById("recent-activity");
    const tbody       = document.getElementById("activities-tbody");

    function authHeaders() {
      return token ? { "Authorization": "Bearer " + token } : {};
    }

    function setMsg(text, ok = true) {
      if (!msgEl) return;
      msgEl.textContent = text;
      msgEl.style.color = ok ? "green" : "crimson";
    }

    // -----------------------------
    // Load facility details
    // -----------------------------
    async function loadFacility() {
      try {
        const resp = await fetch(`/api/facilities/${FACILITY_ID}`, {
          headers: {
            ...authHeaders(),
            "Accept": "application/json"
          },
          credentials: "same-origin",
        });
        if (!resp.ok) {
          const txt = await resp.text();
          console.error("Failed to load facility", resp.status, txt);
          setMsg("Failed to load facility.", false);
          return;
        }
        const data = await resp.json();
        if (nameEl)     nameEl.value     = data.name ?? "";
        if (locationEl) locationEl.value = data.location ?? "";
        if (gridEl)     gridEl.value     = data.grid_region_code ?? "";

        const facName = document.getElementById("fac-name");
        const facLoc  = document.getElementById("fac-loc");
        const facId   = document.getElementById("fac-id");
        const facGrid = document.getElementById("fac-grid");
        if (facName) facName.textContent = "Facility: " + (data.name || "");
        if (facLoc)  facLoc.textContent  = "Location: " + (data.location || "");
        if (facId)   facId.textContent   = "ID: " + (data.facility_id || "");
        if (facGrid) facGrid.textContent = "Grid Region: " + (data.grid_region_code || "");
      } catch (err) {
        console.error("Error loading facility", err);
        setMsg("Error loading facility.", false);
      }
    }

    // -----------------------------
    // Load activities for this facility
    // -----------------------------
    async function loadActivities() {
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="5">Loading…</td></tr>';

      try {
        const resp = await fetch(
          `/api/activities?facility_id=${encodeURIComponent(FACILITY_ID)}`,
          {
            headers: {
              ...authHeaders(),
              "Accept": "application/json"
            },
            credentials: "same-origin",
          }
        );

        if (resp.status === 401) {
          window.location.href = "/login";
          return;
        }

        if (!resp.ok) {
          const txt = await resp.text();
          console.error("Failed to load activities", resp.status, txt);
          tbody.innerHTML =
            `<tr><td colspan="5">Error loading activities (${resp.status}). See console.</td></tr>`;
          return;
        }

        const data = await resp.json();
        tbody.innerHTML = "";

        if (!Array.isArray(data) || !data.length) {
          tbody.innerHTML = '<tr><td colspan="5">No entries yet.</td></tr>';
          return;
        }

        for (const a of data) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${a.activity_date || ""}</td>
            <td>${a.activity_type || ""}</td>
            <td>${a.quantity ?? ""}</td>
            <td>${a.unit || ""}</td>
            <td>
              <button type="button"
                      class="btn"
                      data-delete-id="${a.activity_id}">
                Delete
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("Error loading activities", err);
        tbody.innerHTML =
          '<tr><td colspan="5">Error loading activities (see console).</td></tr>';
      }
    }

    // -----------------------------
    // Delete activity (on click)
    // -----------------------------
    if (recentBox) {
      recentBox.addEventListener("click", async (ev) => {
        const btn = ev.target.closest("[data-delete-id]");
        if (!btn) return;

        const id = btn.getAttribute("data-delete-id");
        if (!id) return;

        if (!confirm("Delete this activity?")) return;

        try {
          const resp = await fetch(`/api/activities/${id}`, {
            method: "DELETE",
            headers: {
              ...authHeaders()
            },
            credentials: "same-origin",
          });

          if (resp.status === 401) {
            window.location.href = "/login";
            return;
          }

          if (!resp.ok) {
            const txt = await resp.text();
            console.error("Failed to delete activity", resp.status, txt);
            alert("Failed to delete activity.");
            return;
          }

          // Remove the row from the table
          const row = btn.closest("tr");
          if (row) row.remove();

          // If no rows left, show placeholder
          if (!tbody.querySelector("tr")) {
            tbody.innerHTML = '<tr><td colspan="5">No entries yet.</td></tr>';
          }
        } catch (err) {
          console.error("Error deleting activity", err);
          alert("Error deleting activity (see console).");
        }
      });
    }

    // Existing facility save/delete functions (no-op on this page if there is no form)
    async function saveFacility(ev) {
      ev.preventDefault();
      setMsg("");
      const payload = {
        name: (nameEl?.value || "").trim(),
        location: (locationEl?.value || "").trim(),
        grid_region_code: (gridEl?.value || "").trim(),
      };
      try {
        const resp = await fetch(`/api/facilities/${FACILITY_ID}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            ...authHeaders(),
          },
          credentials: "same-origin",
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const t = await resp.text();
          setMsg(`Save failed: ${t}`, false);
          return;
        }
        setMsg("Saved.");
      } catch (err) {
        console.error(err);
        setMsg("Error saving.", false);
      }
    }

    async function deleteFacility() {
      if (!confirm("Delete this facility?")) return;
      try {
        const resp = await fetch(`/api/facilities/${FACILITY_ID}`, {
          method: "DELETE",
          headers: authHeaders(),
          credentials: "same-origin",
        });
        if (!resp.ok) {
          const t = await resp.text();
          setMsg(`Delete failed: ${t}`, false);
          return;
        }
        window.location.href = "/facilities";
      } catch (err) {
        console.error(err);
        setMsg("Error deleting.", false);
      }
    }

    const facilityForm = document.getElementById("facility-form");
    if (facilityForm) {
      facilityForm.addEventListener("submit", saveFacility);
    }
    const deleteBtn = document.getElementById("delete-btn");
    if (deleteBtn) {
      deleteBtn.addEventListener("click", deleteFacility);
    }

    loadFacility();
    loadActivities();
  })();
</script>

{% endblock %}
