{% extends "base.html" %}
{% block title %}Factors{% endblock %}
{% block content %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Emission Factors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>
  <main class="container">
    <h1>Emission Factors</h1>

    <section class="card">
      <div class="flex-between">
        <h2>Browse</h2>
        <a class="button" href="/factors/import">Import CSV</a>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Name / Category</th>
              <th>Unit</th>
              <th>Factor</th>
              <th>Source</th>
              <th>Year</th>
            </tr>
          </thead>
          <tbody id="factors-tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Add Single Factor</h2>
      <form id="create-factor-form" class="grid-2">
        <label>
          Name / Category (e.g., Electricity, Diesel)
          <input name="category" type="text" required />
        </label>
        <label>
          Unit (e.g., kg CO2e/kWh)
          <input name="unit" type="text" required />
        </label>
        <label>
          Factor Value
          <input name="factor" type="number" step="0.000001" required />
        </label>
        <label>
          Source (e.g., DEFRA, EPA eGRID)
          <input name="source" type="text" required />
        </label>
        <label>
          Year (optional)
          <input name="year" type="number" min="1900" max="2100" />
        </label>
        <div>
          <button type="submit">Create Factor</button>
        </div>
      </form>
    </section>
  </main>

      <script>
    function authHeaders() {
      const t = localStorage.getItem('token');
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    function requireAuthOrRedirect() {
      if (!localStorage.getItem('token')) {
        window.location.href = '/login';
      }
    }

    async function loadFactors() {
      const tbody = document.getElementById('factors-tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loadingâ€¦</td></tr>';

      try {
        const r = await fetch('/api/factors', {
          headers: {
            ...authHeaders(),
            'Accept': 'application/json'
          }
        });

        if (r.status === 401) {
          window.location.href = '/login';
          return;
        }

        if (!r.ok) {
          const txt = await r.text();
          console.error('Failed to load factors', r.status, txt);
          tbody.innerHTML = `<tr><td colspan="5">Error loading factors (${r.status}). Check server logs.</td></tr>`;
          return;
        }

        const data = await r.json();
        tbody.innerHTML = '';

        if (!Array.isArray(data) || !data.length) {
          tbody.innerHTML = '<tr><td colspan="5">No emission factors yet.</td></tr>';
          return;
        }

        data.forEach(f => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${f.category || ''}</td>
            <td>${f.unit || ''}</td>
            <td>${f.factor}</td>
            <td>${f.source || ''}</td>
            <td>${f.year ?? ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error loading factors', err);
        tbody.innerHTML = '<tr><td colspan="5">Error loading factors (see console).</td></tr>';
      }
    }

    async function createFactor(e) {
      e.preventDefault();
      const form = e.currentTarget;
      const payload = {
        source: form.source.value.trim(),
        category: form.category.value.trim(),
        unit: form.unit.value.trim(),
        factor: Number(form.factor.value),
        year: form.year.value ? Number(form.year.value) : null
      };

      try {
        const r = await fetch('/api/factors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload)
        });
        const res = await r.json();
        if (!r.ok) {
          alert(res.detail || 'Create failed');
          return;
        }
        form.reset();
        loadFactors();
      } catch (err) {
        console.error('Error creating factor', err);
        alert('Error creating factor (see console).');
      }
    }

    document
      .getElementById('create-factor-form')
      .addEventListener('submit', createFactor);

    requireAuthOrRedirect();
    loadFactors();
  </script>


</body>
</html>

{% endblock %}