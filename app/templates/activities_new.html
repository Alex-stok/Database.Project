
{% extends "base.html" %}
{% block title %}Page Title Here{% endblock %}
{% block content %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Log Activity</title>
  <link rel="stylesheet" href="/static/css/main.css">
</head>

<body>
  <h2>New Activity</h2>
  <form id="activityForm">
    <label>Activity type
      <select name="activity_type">
        <option value="electricity">Electricity</option>
        <option value="natural_gas">Natural Gas</option>
        <option value="diesel">Diesel Fuel</option>
        <option value="gasoline">Gasoline Fuel</option>
        <option value="shipping">Freight/Shipping</option>
        <option value="process">Process Emissions</option>
      </select>
    </label>

    <label>Quantity
      <input type="number" step="0.0001" name="quantity" required>
    </label>

    <label>Unit (required for accuracy)
      <select name="unit" required>
        <option value="kWh">kWh (electricity)</option>
        <option value="therm">therm (natural gas)</option>
        <option value="m3">mÂ³ (natural gas or water)</option>
        <option value="gal">gallons (fuels)</option>
        <option value="L">liters (fuels)</option>
        <option value="ton_mile">ton-mile (freight)</option>
        <option value="kg">kg (process/material)</option>
      </select>
    </label>

    <label>Activity date <input type="date" name="activity_date" required></label>
    <label>Facility ID <input type="number" name="facility_id" placeholder="e.g., 1"></label>
    <button type="submit">Submit</button>

    <script>
(async function () {
  const token = localStorage.getItem('token') || '';
  const form = document.getElementById('activityForm');

  // Load selectable lists
  const typesResp = await fetch('/api/activities/types', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const unitsResp = await fetch('/api/activities/units', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const facResp = await fetch('/api/facilities', {
    headers: { 'Authorization': 'Bearer ' + token }
  });

  const types = typesResp.ok ? await typesResp.json() : [];
  const units = unitsResp.ok ? await unitsResp.json() : [];
  const facs  = facResp.ok ? await facResp.json()  : [];

  // Populate selects
  const typeSel = form.querySelector('select[name="activity_type"]');
  const unitSel = form.querySelector('select[name="unit"]');
  const facSel  = form.querySelector('input[name="facility_id"]');

  typeSel.innerHTML = types.map(t =>
    `<option value="${t.activity_type_id}">${t.label}</option>`
  ).join("");

  unitSel.innerHTML = units.map(u =>
    `<option value="${u.unit_id}">${u.code}</option>`
  ).join("");

  // Optional: prefill facility ID dropdown
  // Replace input with dropdown:
  /*
  facSel.outerHTML = `
      <select name="facility_id">
        ${facs.map(f => `<option value="${f.facility_id}">${f.name}</option>`).join("")}
      </select>
  `;
  */

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);

    const payload = {
      activity_type_id: Number(fd.get("activity_type")),
      unit_id: Number(fd.get("unit")),
      quantity: Number(fd.get("quantity")),
      facility_id: Number(fd.get("facility_id")),
      activity_date: fd.get("activity_date")
    };

    const resp = await fetch('/api/activities', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      alert("Error: " + await resp.text());
      return;
    }

    alert("Activity logged.");
    form.reset();
  });
})();
</script>


  </form>
</body>
</html>

{% endblock %}