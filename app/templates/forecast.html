{% extends "base.html" %}
{% block title %}Forecast{% endblock %}
{% block content %}
<h1 class="page-title">Forecast</h1>

<section class="card">
  <form id="forecast-form">
    <label>Annual growth (%)
      <input type="number" name="growth_pct" step="0.1" value="3">
    </label>
    <label>Renewable share (% of annual kWh)
      <input type="number" name="renewable_share_pct" step="1" value="20">
    </label>
    <label>Years to project (years)
      <input type="number" name="years" min="1" max="10" value="3">
    </label>
    <button type="submit">Run forecast</button>
  </form>
</section>

<section class="card">
  <h3>Projection (kg CO₂e)</h3>
  <pre id="forecast-out">Submit to see results…</pre>
</section>

<script>
(function () {
  const token = localStorage.getItem('token') || '';
  const form = document.getElementById('forecast-form');
  const out = document.getElementById('forecast-out');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const fd = new FormData(form);
    const payload = {
      name: "Auto scenario",
      annual_growth_pct: Number(fd.get("growth_pct")),
      renewable_share_pct: Number(fd.get("renewable_share_pct")),
      start_year: new Date().getFullYear(),
      end_year: new Date().getFullYear() + Number(fd.get("years"))
    };

    // 1) Create the scenario
    const createResp = await fetch('/api/forecast/scenario', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    if (!createResp.ok) {
      out.textContent = 'Error creating scenario: ' + await createResp.text();
      return;
    }

    const scenario = await createResp.json();

    // 2) Run / fetch scenario results
    const runResp = await fetch(`/api/forecast/scenario/${scenario.scenario_id}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });

    out.textContent = runResp.ok
      ? JSON.stringify(await runResp.json(), null, 2)
      : 'Error ' + runResp.status + ': ' + await runResp.text();
  });
})();
</script>

{% endblock %}
